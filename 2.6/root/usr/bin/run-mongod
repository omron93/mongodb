#!/bin/bash

source ${CONTAINER_SCRIPTS_PATH}/base-functions.sh

set -eu

# Shutdown mongod on SIGINT/SIGTERM
function cleanup() {
  echo "=> Shutting down MongoDB server ..."
  if [ -s $dbpath/mongod.lock ]; then
    mongod $mongod_common_args --shutdown
  fi
  wait_mongo "DOWN"

  exit 0
}

mongod_config_file="/etc/mongod.conf"

# Get options from config file
dbpath=$(get_option "dbpath" $mongod_config_file)

# Get used port
port=$(get_port $mongod_config_file)
port=${port:-27017}

trap 'cleanup' SIGINT SIGTERM

# Add default config file
mongod_common_args+="-f $mongod_config_file "
mongod_local_args+="--bind_ip localhost "

# Run scripts before mongod start
source ${CONTAINER_SCRIPTS_PATH}/pre-init.sh

# Start background MongoDB service with disabled authentication
mongod $mongod_common_args $mongod_local_args &
wait_mongo "UP"

# Run scripts with started mongod
source ${CONTAINER_SCRIPTS_PATH}/init.sh

# Stop background MongoDB service to exec mongod
mongod $mongod_common_args $mongod_local_args --shutdown
wait_mongo "DOWN"

# Run scripts before exec mongod 
source ${CONTAINER_SCRIPTS_PATH}/post-init.sh

# Start MongoDB service with enabled authentication
exec mongod $mongod_common_args
